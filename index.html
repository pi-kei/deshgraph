<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">
    <title>deshgraph</title>
  </head>
  <body>
    <form id="form">
      <label for="expr">Expression:</label>
      0&nbsp;=&nbsp;<input type="text" id="expr" value="x*x+y*y+w*w+sin(u)-1" />
      <fieldset>
        <legend>Axes</legend>
        <select id="axes" size="4" style="min-width: 100px"></select>
        <input type="button" id="upButton" value="Up" />
        <input type="button" id="downButton" value="Down" />
        <input type="button" id="removeButton" value="Remove" />
        <br/>
        <label for="name">Name:</label>
        <input type="text" id="name" value="x" />
        <br/>
        <label for="startValue">Start value:</label>
        <input type="number" id="startValue" value="0" />
        <br/>
        <label for="endValue">End value:</label>
        <input type="number" id="endValue" value="1" />
        <br/>
        <label for="valuesCount">Steps:</label>
        <input type="number" id="valuesCount" value="2" min="2" />
        <br/>
        <label for="vertical">Vertical:</label>
        <input type="checkbox" id="vertical" />
        <br/>
        <label for="forward">Forward:</label>
        <input type="checkbox" id="forward" />
        <br/>
        <input type="button" id="addAxisButton" value="Add axis" />
      </fieldset>
      <input type="submit" value="Draw" />
    </form>
    <canvas id="canvas" style="border: 1px solid black" width="100" height="100"></canvas>
    <script>
      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext('2d');

      var expression = '0';
      var axes = [];
      var sortedAxes = [];
      var cols = 1;
      var rows = 1;

      function start() {
        var i;

        for (i = 0; i < axes.length; ++i)
        {
          sortedAxes[i] = axes[i];
          if (axes[i].vertical)
          {
            axes[i].span = rows;
            rows *= axes[i].valuesCount;
          }
          else
          {
            axes[i].span = cols;
            cols *= axes[i].valuesCount;
          }
        }

        sortedAxes.sort(function (a, b) {
          if (a.index < b.index) return -1;
          if (a.index > b.index) return 1;
          return 0;
        });

        sortedAxes[0].digitWeight = 1;
        for (i = 1; i < sortedAxes.length; ++i)
        {
          sortedAxes[i].digitWeight = sortedAxes[i - 1].digitWeight * sortedAxes[i - 1].valuesCount;
        }

        canvas.width = cols;
        canvas.height = rows;
      }

      canvas.onclick = function (e) {
        var rect = canvas.getBoundingClientRect();
        var col = e.clientX - rect.left;
        var row = e.clientY - rect.top;
        var coords = '';
        var i;
        var j;
        var index = 0;
        for ( i = 0; i < sortedAxes.length; ++i)
        {
          j = (sortedAxes[i].vertical ? row : col) / sortedAxes[i].span % sortedAxes[i].valuesCount;
          if (!sortedAxes[i].forward) {
            j = sortedAxes[i].valuesCount - 1 - j;
          }
          index += j * sortedAxes[i].digitWeight;
          coords += (coords.length > 0 ? ' ' : '') + sortedAxes[i].name + '=' + (sortedAxes[i].startValue + j * sortedAxes[i].delta);
        }
        console.log('row=' + row + ' col=' + col + ' index=' + index + ' ' + coords);
      };

      var rectSize = 100;
      var horRects = Math.ceil(cols / rectSize);
      var verRects = Math.ceil(rows / rectSize);
      var totalRects = horRects * verRects;
      var currentRectIndex = [];
      var totalWorkers = 4;

      function getNextRect(index) {
        currentRectIndex[index] += totalWorkers;
        if (currentRectIndex[index] >= totalRects) {
          return { type: 'done' };
        }
        var y = Math.floor(currentRectIndex[index] / horRects) * rectSize;
        var x = (currentRectIndex[index] % horRects) * rectSize;
        return {
          type: 'drawRect',
          imageData: ctx.getImageData(x, y, rectSize, rectSize),
          x: x,
          y: y,
          w: rectSize,
          h: rectSize
        };
      }

      function messageHandler(e) {
        var message = e.data;
        var worker = e.target;
        if (message.type === 'init') {
          worker.postMessage(getNextRect(message.index));
        } else if (message.type === 'drawRect') {
          ctx.putImageData(message.imageData, message.x, message.y);
          worker.postMessage(getNextRect(message.index));
        } else if (message.type === 'error') {
          if (message.index === 0) {
            alert('Something wrong with expression or you did not add all axes');
          }
          worker.postMessage({ type: 'done' });
        }
      }

      function createWorkers() {
        if (!window.Worker) {
          return;
        }
        horRects = Math.ceil(cols / rectSize);
        verRects = Math.ceil(rows / rectSize);
        totalRects = horRects * verRects;
        currentRectIndex = [];
        var i;
        var worker;
        for (i = 0; i < totalWorkers; ++i) {
          worker = new Worker('deshgraph-worker.js');
          currentRectIndex[i] = i - totalWorkers;
          worker.onmessage = messageHandler;
          worker.postMessage({type: 'init', index: i, sortedAxes: sortedAxes, expression: expression});
        }
      }

      function axisToString(axis) {
        return axis.name +
          ' [' + axis.startValue + ', ' + (axis.startValue + axis.delta * axis.valuesCount) + '] ' +
          (axis.forward ? (axis.vertical ? '↓' : '→') : (axis.vertical ? '↑' : '←'));
      }

      document.getElementById('form').onsubmit = function (e) {
        e.preventDefault();

        if (axes.length == 0) {
          alert('Add axes');
          return;
        }

        e.target.style.display = 'none';
        expression = document.getElementById('expr').value;
        start();
        createWorkers();
      };

      document.getElementById('addAxisButton').onclick = function (e) {
        e.preventDefault();
        var name = document.getElementById('name').value;
        var startValue = parseFloat(document.getElementById('startValue').value);
        var endValue = parseFloat(document.getElementById('endValue').value);
        var valuesCount = parseInt(document.getElementById('valuesCount').value, 10);
        var vertical = document.getElementById('vertical').checked;
        var forward = document.getElementById('forward').checked;

        if (axes.filter(function (elem) { return elem.name === name; }).length > 0) {
          alert('Name must be unique');
          return;
        }

        if (startValue >= endValue) {
          alert('Start value must be less than end value');
          return;
        }

        var axis = {
          index: axes.length,
          name: name,
          startValue: startValue,
          valuesCount: valuesCount,
          delta: (endValue - startValue) / valuesCount,
          vertical: vertical,
          forward: forward,
          span: 1,
          digitWeight: 1
        };
        axes.push(axis);
        var option = document.createElement('option');
        option.text = axisToString(axis);
        var select = document.getElementById('axes');
        select.add(option);
      };

      document.getElementById('upButton').onclick = function (e) {
        e.preventDefault();
        var select = document.getElementById('axes');
        var selectedIndex = select.selectedIndex;
        if (selectedIndex < 0) {
          return;
        }
        if (selectedIndex == 0) {
          return;
        }
        var axis = axes[selectedIndex];
        axes[selectedIndex] = axes[selectedIndex - 1];
        axes[selectedIndex - 1] = axis;
        select.options[selectedIndex - 1].text = axisToString(axes[selectedIndex - 1]);
        select.options[selectedIndex].text = axisToString(axes[selectedIndex]);
      };

      document.getElementById('downButton').onclick = function (e) {
        e.preventDefault();
        var select = document.getElementById('axes');
        var selectedIndex = select.selectedIndex;
        if (selectedIndex < 0) {
          return;
        }
        if (selectedIndex == axes.length - 1) {
          return;
        }
        var axis = axes[selectedIndex];
        axes[selectedIndex] = axes[selectedIndex + 1];
        axes[selectedIndex + 1] = axis;
        select.options[selectedIndex + 1].text = axisToString(axes[selectedIndex + 1]);
        select.options[selectedIndex].text = axisToString(axes[selectedIndex]);
      };

      document.getElementById('removeButton').onclick = function (e) {
        e.preventDefault();
        var select = document.getElementById('axes');
        var selectedIndex = select.selectedIndex;
        if (selectedIndex < 0) {
          return;
        }
        var axis = axes.splice(selectedIndex, 1)[0];
        var i;
        for (i = 0; i < axes.length; ++i) {
          if (axes[i].index >= axis.index) {
            --axes[i].index;
          }
        }
        select.remove(select.selectedIndex);
      };
    </script>
  </body>
</html>
